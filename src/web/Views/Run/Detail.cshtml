@model TaskRunDetailViewModel

<div class="border rounded p-2 my-2">
    <div class="row mb-2">
        <div class="col-md-2 fw-bold">Id</div>
        <div class="col-md-4">
            #@Model.RunId
        </div>
        <div class="col-md-2 fw-bold">Task</div>
        <div class="col-md-4">
            @Model.TaskName (<a href="/task?id=@Model.TaskId">#@Model.TaskId</a>)
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-2 fw-bold">Created At</div>
        <div class="col-md-4">
            <span title="@Model.CreatedAt">@Model.CreatedAtDisplay</span>
        </div>
        <div class="col-md-2 fw-bold">Status</div>
        <div class="col-md-4" id="status">
            -
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-2 fw-bold">Started At</div>
        <div class="col-md-4" id="startedAt">
            -
        </div>
        <div class="col-md-2 fw-bold">Completed At</div>
        <div class="col-md-4" id="completedAt">
            -
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-2 fw-bold">Elapsed</div>
        <div class="col-md-10" id="elapsed">
            -
        </div>
    </div>
</div>

<h4>Output</h4>
<p class="small">Displaying latest <span id="outputLength">0</span> records, check full records <a href="/run/@Model.RunId/output/raw" target="_blank">here</a>.</p>
<div id="output" class="overflow-auto p-2 height-max-2 border rounded mb-2">
</div>

<h4>Snapshot</h4>
<div class="my-2">
    <div class="row">
        <div class="col-md-2 fw-bold">Shell Name: </div>
        <div class="col-md-2">@Model.ShellName</div>
        <div class="col-md-2 fw-bold">Shell Options: </div>
        <div class="col-md-2">@Model.ShellOption</div>
        <div class="col-md-2 fw-bold">Shell Extension: </div>
        <div class="col-md-2">@Model.ShellExt</div>
    </div>
    
    <div class="overflow-auto height-max-1 border rounded my-3">
        <pre id="snapshotScript" class="m-0 p-2">@Model.Script</pre>
    </div>
</div>

@section Scripts {
    <script>
        let statusEl = document.querySelector("#status");
        let startedAtEl = document.querySelector("#startedAt");
        let completedAtEl = document.querySelector("#completedAt");
        let elapsedEl = document.querySelector("#elapsed");
        let outputEl = document.querySelector("#output");
        let outputLengthEl = document.querySelector("#outputLength");
        let lastPoint = 0;
        let outputElChildrenLength = 0;

        let interval = setInterval(function() {
                submitRequest(`/api/run/@Model.RunId/output?lastPoint=${lastPoint}`,
                    {
                        okAction: function(res) {
                            lastPoint = res.lastPoint;
                            statusEl.innerHTML = res.status;
                            startedAtEl.innerHTML = res.startedAt;
                            startedAtEl.setAttribute("title", res.startedAtTooltip);
                            completedAtEl.innerHTML = res.completedAt;
                            completedAtEl.setAttribute("title", res.completedAtTooltip);
                            elapsedEl.innerHTML = res.elapsed;
                            addToOutput(res.outputs);

                            if (res.status === "Completed" || res.status === "Stopped" || res.status === "Dead") {
                                clearInterval(interval);
                            }
                        }
                    });
            },
            2000);

        function addToOutput(outputs) {
            let childrenLengthToRemove = outputElChildrenLength + outputs.length - 100;
            let childrenToRemove = [];
            outputEl.querySelectorAll("pre").forEach(el => {
                if (childrenToRemove.length === childrenLengthToRemove) {
                    return;
                }

                childrenToRemove.push(el);
            });

            childrenToRemove.forEach(el => el.remove());

            outputs.forEach(o => {
                let el = document.createElement("pre");
                el.innerText = o.message;
                el.classList.add("m-0");
                outputEl.appendChild(el);
            });

            if (childrenToRemove > 0) {
                outputElChildrenLength = 100;
            } else {
                outputElChildrenLength = outputs.length;
            }

            outputLengthEl.innerText = outputElChildrenLength;
        }

        hljs.highlightElement(document.querySelector("#snapshotScript"));


    </script>
}